<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Attendance Check-In</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#2D1B4E; --brand-dark:#1F132F; --brand-light:#3D2B5E;
    --accent-gold:#D4AF37; --ok:#118a0a; --warn:#d97706; --err:#b91c1c;
    --checkout:#dc2626; --checkout-dark:#b91c1c;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;color:#111;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,#2D1B4E 0%,#3D2B5E 100%);
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .wrap{ width:100%; max-width:600px; }
  .card{
    background:#fff; border-radius:16px; padding:28px 20px;
    box-shadow:0 18px 40px rgba(0,0,0,.25); border-top:4px solid var(--accent-gold);
  }
  h1{
    margin:0 0 10px; font-size:26px; text-align:center;
    background:linear-gradient(90deg,#2D1B4E,#3D2B5E);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    font-family:'Playfair Display',Georgia,serif; font-weight:800;
  }
  .muted{ color:#555; font-size:13px; margin:0 0 20px; text-align:center; line-height:1.4; }
  label{ display:block; margin:16px 0 8px; font-weight:600; color:#2D1B4E; font-size:15px; }
  input,select,button{ width:100%; padding:14px 16px; border:1px solid #d8dee9; border-radius:12px; background:#fff; font-size:16px; }
  input[readonly]{ background:#f3f4f6; color:#6b7280; cursor:not-allowed; }
  button{ border:none; font-weight:700; cursor:pointer; font-family:'Playfair Display',Georgia,serif; transition: all 0.2s; }
  button:disabled{ background:#c4b8d3 !important; cursor:not-allowed; color:#fff; }
  .button-row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:24px; }
  .btn-checkin{ background:var(--brand); color:#fff; }
  .btn-checkout{ background:var(--checkout); color:#fff; }
  .msg{ margin-top:16px; padding:14px; border-radius:12px; font-size:14px; display:none; }
  .msg.ok{ display:block; background:#ecfdf5; color:var(--ok); border:1px solid #bbf7d0; }
  .msg.warn{ display:block; background:#fffbeb; color:var(--warn); border:1px solid #fde68a; }
  .msg.err{ display:block; background:#fef2f2; color:var(--err); border:1px solid #fecaca; }
  .msg.info{ display:block; background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe; }
  .session-info{ background:#f8f9fa; border-radius:12px; padding:16px; margin-top:16px; display:none; border-left:4px solid var(--accent-gold); }
  .session-info.active{ display:block; }
  .time-display{ text-align:center; font-size:32px; font-weight:800; color:var(--brand); margin-top:10px; font-family:'Playfair Display',serif; }
  
  .help-section{ margin-top:20px; font-size:12px; color:#666; border-top:1px dashed #ccc; padding-top:15px; }
  details{ cursor:pointer; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #eee; margin-top:8px; }
  summary{ font-weight:600; color:#444; outline:none; }

  .footer-detailed{ text-align:center; margin-top:24px; padding-top:20px; border-top:1px solid #e5e7eb; }
  .footer-copyright{ color:#2D1B4E; font-size:11px; font-weight:600; margin-bottom:8px; line-height:1.5; }
  .footer-acknowledgment{ color:#555; font-size:10px; line-height:1.6; font-style:italic; padding:12px; background:#f9fafb; border-radius:8px; margin-top:12px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Attendance Check-In</h1>
      <p class="muted">Ensure your location is enabled and your ID matches <b>aXcelerate</b>. Fill in once and it will be remembered.</p>

      <form onsubmit="return false;">
        <label>aXcelerate Contact ID (8 Digits)</label>
        <input id="studentId" type="text" inputmode="numeric" maxlength="8" placeholder="Enter 8-digit ID" required />

        <label>Full Name</label>
        <input id="name" placeholder="Automatic after ID verification" required readonly />

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div>
            <label>Trainer</label>
            <select id="trainer" required><option value="">‚Äî Select ‚Äî</option></select>
          </div>
          <div>
            <label>Course</label>
            <select id="course" required><option value="">‚Äî Select ‚Äî</option></select>
          </div>
        </div>

        <div class="button-row">
          <button type="button" id="btnCheckIn" class="btn-checkin" disabled onclick="submitCheckIn()">‚ûú Check In</button>
          <button type="button" id="btnCheckOut" class="btn-checkout" disabled onclick="submitCheckOut()">‚úì Check Out</button>
        </div>
      </form>

      <div id="sessionInfo" class="session-info">
        <div style="color:var(--brand); font-weight:700;">Active Session: <span id="sessionCampus"></span></div>
        <div id="timeElapsed" class="time-display">00:00:00</div>
      </div>

      <div id="msg" class="msg"></div>

      <div class="help-section">
        <p style="font-weight:bold; color:var(--brand); margin-bottom:5px;">üìç Need Help?</p>
        <details>
          <summary style="color:#2563eb;">How to find my aXcelerate ID?</summary>
          <div style="padding-top:10px; color:#444;">Login to <b>aXcelerate</b> > Click <b>Profile Icon</b> > See <b>8-digit Contact ID</b>.</div>
        </details>
        <details>
          <summary>Trouble with Location / GPS?</summary>
          <div style="padding-top:10px;"><b>iOS:</b> Settings > Privacy > Location > Safari > "While Using".<br><b>Android:</b> Settings > Location > Chrome > "Allow".</div>
        </details>
      </div>

      <div class="footer-detailed">
        <div class="footer-copyright">¬©2025 Charlton Brown Pty Ltd. CRICOS 03822D | RTO 2508</div>
        <div class="footer-acknowledgment">We acknowledge the Traditional Owners of the lands on which we work and learn.</div>
      </div>
    </div>
  </div>

<script>
// --- CONFIGURATION ---
const VALIDATION_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/81f10f23308c4b24a0b9f98834c38762/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=d4QPWjNPGD4ZsLIwt2bsk837TFZc24haYGBp9QErS6s";
const CHECKIN_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9ed041ac7ca143a0b262334d9dfc13d5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=il-cX-qHDZbGSxE2OnN56BK2jdJIgxWXFIStUm65G6g";
const CHECKOUT_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2e4266def4fe44618e9eddd28221178c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NfMkFq1ITZSPcQNVmn6Ikt7OPS0NUA_Yp-Q9QP8TFoQ";

const TRAINER_COURSES = {
  "Carlos Castellano": ["SIT30821 Certificate III in Commercial Cookery"],
  "Carol Ly": ["CHC43015 Certificate IV in Ageing Support", "CHC52021 Diploma of Community Services"],
  "Chloe BIAN": ["CHC30121 Certificate III in Early Childhood Education and Care", "CHC50121 Diploma of Early Childhood Education and Care"],
  "Edwin Zywko-Hicks": ["BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Fei Yu": ["CHC50121 Diploma of Early Childhood Education and Care"],
  "Gunther Zywko-Hicks": ["SIT50422 Diploma of Hospitality Management"],
  "Jan Cisler": ["HLT52021 Diploma of Remedial Massage"],
  "John Black": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management", "SIT50422 Diploma of Hospitality Management"],
  "John Owen": ["SIT50422 Diploma of Hospitality Management"],
  "Kylie MA": ["BSB50420 Diploma of Leadership and Management"],
  "Laurent Le Souquet": ["SIT30821 Certificate III in Commercial Cookery"],
  "Li Tang": ["CHC30121 Certificate III in Early Childhood Education and Care"],
  "Lily YE": ["BSB40120 Certificate IV in Business"],
  "Marc Bishop": ["SIT40521 Certificate IV in Kitchen Management"],
  "Marty Gray": ["BSB30120 Certificate III in Business", "BSB40120 Certificate IV in Business", "BSB50120 Diploma of Business", "BSB50420 Diploma of Leadership and Management", "BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Mathew Little": ["BSB50420 Diploma of Leadership and Management"],
  "Matthew Facey": ["BSB50420 Diploma of Leadership and Management"],
  "Nicole Hicks/Nati": ["CHC30121 Certificate III in Early Childhood Education and Care", "CHC50121 Diploma of Early Childhood Education and Care"],
  "Niral Joshi": ["BSB50120 Diploma of Business UniTrack", "BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Pelin Tatlidil": ["ICT50220 Diploma of Information Technology"],
  "Peter NG": ["RII60520 Advanced Diploma of Civil Construction"],
  "Richard LIM": ["BSB30120 Certificate III in Business", "BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Robert Sauer": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management"],
  "Rona": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management"],
  "Rosha Huang": ["HLT52021 Diploma of Remedial Massage"],
  "Ruying Shao": ["SIT50422 Diploma of Hospitality Management"],
  "Sherwin Thiarhia": ["CHC33021 Certificate III in Individual Support", "CHC43015 Certificate IV in Ageing Support"],
  "Tanya Caterson": ["SIT30821 Certificate III in Commercial Cookery"],
  "Toriqul Mozumder": ["CHC33021 Certificate III in Individual Support", "CHC52021 Diploma of Community Services"],
  "Wendi Wei": ["HLT52021 Diploma of Remedial Massage"]
};

const campuses = [
  { name:"Brisbane 102 Adelaide", lat:-27.4680, lng:153.0247, radius:0.3 },
  { name:"Brisbane 316 Adelaide", lat:-27.4650, lng:153.0287, radius:0.3 },
  { name:"Gold Coast Campus", lat:-27.9725, lng:153.4150, radius:0.3 },
  { name:"Hobart Campus", lat:-42.8848, lng:147.3254, radius:0.3 }
];

let gpsReady=false, latestLat=null, latestLng=null, detectedCampus=null, activeSession=null, timerInterval=null;
const elId=document.getElementById('studentId'), elName=document.getElementById('name'), elTrainer=document.getElementById('trainer'), elCourse=document.getElementById('course'), elBtnIn=document.getElementById('btnCheckIn'), elBtnOut=document.getElementById('btnCheckOut');

function setMsg(txt, cls){
  const el = document.getElementById('msg');
  el.innerHTML = txt; el.className = 'msg ' + cls; el.style.display = 'block';
}

function updateButtonStates(){
  const isIdValid = elId.value.trim().length === 8;
  const filled = isIdValid && elName.value.trim() && elTrainer.value && elCourse.value;
  if(activeSession){
    elBtnIn.disabled = true; elBtnOut.disabled = !gpsReady;
  } else {
    elBtnIn.disabled = !(filled && gpsReady && detectedCampus);
    elBtnOut.disabled = true;
  }
}

// --- aXcelerate ID Validation ---
elId.onblur = async () => {
    const id = elId.value.trim();
    if(id.length === 8) {
        setMsg("‚è≥ Verifying ID with aXcelerate...", "info");
        try {
            const res = await fetch(VALIDATION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ StudentID: id })
            });
            const data = await res.json();
            if(data.givenName && data.givenName !== "null") {
                elName.value = `${data.givenName} ${data.surname}`;
                elName.readOnly = true;
                setMsg(`‚úÖ Verified: ${elName.value}`, "ok");
            } else {
                setMsg("‚ùå Student ID not found in aXcelerate.", "err");
                elId.value = ""; elName.value = "";
            }
        } catch (e) {
            setMsg("‚ö†Ô∏è Connection to aXcelerate timed out. Manual entry enabled.", "warn");
            elName.readOnly = false;
        }
    }
    updateButtonStates();
};

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!activeSession) return;
    if (new Date().getHours() >= 17) {
      clearInterval(timerInterval);
      localStorage.removeItem('activeSession');
      activeSession = null;
      document.getElementById('sessionInfo').classList.remove('active');
      setMsg("Class ended at 5:00 PM. Auto-checked out.", "info");
      updateButtonStates();
      return;
    }
    const sec = Math.floor((Date.now() - activeSession.checkInTime)/1000);
    const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
    document.getElementById('timeElapsed').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }, 1000);
}

function onGPSSuccess(pos){
  latestLat = pos.coords.latitude; latestLng = pos.coords.longitude;
  gpsReady = true;
  const haversine = (lat1,lon1,lat2,lon2) => {
    const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  };
  detectedCampus = campuses.find(c => haversine(latestLat, latestLng, c.lat, c.lng) <= c.radius);
  if(!detectedCampus && !activeSession) setMsg("üìç You are not on campus.", "warn");
  else if(detectedCampus) document.getElementById('msg').style.display = 'none';
  updateButtonStates();
}

function onGPSError(err){ gpsReady = false; updateButtonStates(); setMsg("<b>GPS Error:</b> Access denied.", "err"); }

Object.keys(TRAINER_COURSES).sort().forEach(t => {
  const opt = document.createElement('option'); opt.value = t; opt.textContent = t; elTrainer.appendChild(opt);
});

elTrainer.onchange = () => {
  elCourse.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
  if(TRAINER_COURSES[elTrainer.value]) TRAINER_COURSES[elTrainer.value].forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; elCourse.appendChild(opt);
  });
  updateButtonStates();
};

[elId, elName, elCourse].forEach(el => el.oninput = updateButtonStates);

async function submitCheckIn(){
  if (new Date().getHours() >= 17) return;
  setMsg("‚è≥ Submitting...", "info");
  elBtnIn.disabled = true;
  try {
    const res = await fetch(CHECKIN_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        StudentID:elId.value, Name:elName.value, Trainer:elTrainer.value, Course:elCourse.value,
        Campus:detectedCampus.name, Lat:latestLat, Lng:latestLng, CheckInTime:new Date().toISOString()
      })
    });
    if(res.ok){
      localStorage.setItem('r_id', elId.value); localStorage.setItem('r_name', elName.value);
      localStorage.setItem('r_trainer', elTrainer.value); localStorage.setItem('r_course', elCourse.value);
      activeSession = { studentId: elId.value, name: elName.value, trainer: elTrainer.value, course: elCourse.value, campus: detectedCampus.name, checkInTime: Date.now() };
      localStorage.setItem('activeSession', JSON.stringify(activeSession));
      document.getElementById('sessionInfo').classList.add('active');
      document.getElementById('sessionCampus').textContent = activeSession.campus;
      startTimer();
      setMsg("‚úÖ Check-in successful!", "ok");
      updateButtonStates();
    }
  } catch(e) { setMsg("‚ùå Network error.", "err"); }
}

async function submitCheckOut(){
  setMsg("‚è≥ Checking out...", "info");
  elBtnOut.disabled = true;
  try {
    const durationMin = Math.floor((Date.now() - activeSession.checkInTime)/60000);
    const res = await fetch(CHECKOUT_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ StudentID: activeSession.studentId, Name: activeSession.name, DurationMinutes: durationMin, Hours: Math.round(durationMin/60) })
    });
    if(res.ok){
      localStorage.removeItem('activeSession');
      activeSession = null;
      document.getElementById('sessionInfo').classList.remove('active');
      if(timerInterval) clearInterval(timerInterval);
      setMsg("‚úÖ Success!", "ok");
      updateButtonStates();
    }
  } catch(e) { setMsg("‚ùå Error.", "err"); }
}

function init() {
  const saved = localStorage.getItem('activeSession');
  if (saved) {
    const session = JSON.parse(saved);
    if (new Date(session.checkInTime).toDateString() !== new Date().toDateString() || new Date().getHours() >= 17) {
      localStorage.removeItem('activeSession');
    } else {
      activeSession = session;
      document.getElementById('sessionInfo').classList.add('active');
      document.getElementById('sessionCampus').textContent = activeSession.campus;
      startTimer();
    }
  }
  const r_id = localStorage.getItem('r_id'), r_name = localStorage.getItem('r_name'), r_trainer = localStorage.getItem('r_trainer'), r_course = localStorage.getItem('r_course');
  if(r_id) elId.value = r_id; if(r_name) { elName.value = r_name; elName.readOnly = true; }
  if(r_trainer) {
    elTrainer.value = r_trainer; elTrainer.dispatchEvent(new Event('change'));
    setTimeout(() => { if(r_course) elCourse.value = r_course; updateButtonStates(); }, 150);
  }
}

init();
navigator.geolocation.watchPosition(onGPSSuccess, onGPSError, {enableHighAccuracy:true});
</script>
</body>
</html>
